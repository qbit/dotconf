#!/bin/sh

set -e

rage_dir=~/.rage
rage_id_file="$(awk -F= '/^identity/{print $NF}' ${rage_dir}/config)"
rage_recips="$(awk -F= '/^recipients/{print $NF}' ${rage_dir}/config)"

# expand ~ if we have it (age doesn't to it for us)
rage_id_file=${rage_id_file/#\~/$HOME}
rage_recips=${rage_recips/#\~/$HOME}

cmd=$1

list() {
	find $rage_dir -type f -name \*.age
}

if [ -z ${cmd} ]; then
	list
	exit
fi

case $cmd in
	ls)
		list
		;;
	re)
		F=""
		if [ -f $2 ]; then
			F=$2
		else
			F=$(list | grep $2)
		fi

		echo "Re-encrypting: '${F}'"
		pass="$(age -i $rage_id_file -d "${F}")"
		echo "$pass" | age -a -R "${rage_recips}" > "${F}"
		;;
	en)
		printf 'Password: '
		stty -echo
		read pass
		stty echo
		echo ""
		printf 'Location: '
		read loc
		echo ""
		mkdir -p "$(dirname ~/.rage/${loc})"
		echo "$pass" | age -a -R "${rage_recips}" > ~/.rage/${loc}.age
		;;
	de)
		if [ -f $2 ]; then
			age -i $rage_id_file -d $2
		else
			F=$(list | grep $2)
			age -i $rage_id_file -d "${F}"
		fi
		;;
	otp)
		if [ -f $2 ]; then
			age -i $rage_id_file -d $2 | oathtool -b --totp -
		else
			F=$(list | grep $2)
			age -i $rage_id_file -d "${F}" | oathtool -b --totp -
		fi
		;;
	push)
		cd $rage_dir
		git push
		;;
	sync)
		cd $rage_dir
		git pull
		git push
		;;
	default)
		list
esac
